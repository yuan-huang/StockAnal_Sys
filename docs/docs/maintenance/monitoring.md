# 系统监控

## 概述

系统监控是确保系统稳定运行的关键环节。本文档描述了系统的监控策略、监控指标、告警机制和运维流程。

## 监控架构

### 监控体系

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   应用层监控     │    │   系统层监控     │    │   基础设施监控   │
│                 │    │                 │    │                 │
│ - 性能指标      │    │ - 资源使用      │    │ - 网络状态      │
│ - 业务指标      │    │ - 进程状态      │    │ - 存储状态      │
│ - 错误率        │    │ - 系统负载      │    │ - 服务状态      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   数据收集层     │    │   告警通知层     │
                       │                 │    │                 │
                       │ - Prometheus    │    │ - 告警规则      │
                       │ - 日志收集      │    │ - 通知渠道      │
                       │ - 指标聚合      │    │ - 升级策略      │
                       └─────────────────┘    └─────────────────┘
```

## 监控指标

### 1. 应用性能指标

#### 响应时间
- **平均响应时间**：目标 < 200ms
- **95% 分位响应时间**：目标 < 500ms
- **99% 分位响应时间**：目标 < 1000ms

#### 吞吐量
- **请求速率**：QPS (每秒查询数)
- **并发用户数**：活跃用户数量
- **处理能力**：每秒处理请求数

#### 错误率
- **HTTP 错误率**：目标 < 1%
- **业务错误率**：目标 < 0.1%
- **系统异常率**：目标 < 0.01%

### 2. 系统资源指标

#### CPU 使用率
- **CPU 使用率**：目标 < 70%
- **CPU 负载**：目标 < 2.0
- **进程 CPU 使用**：按进程监控

#### 内存使用率
- **内存使用率**：目标 < 80%
- **内存可用量**：保持 > 20%
- **内存交换率**：目标 < 1%

#### 磁盘使用率
- **磁盘使用率**：目标 < 85%
- **磁盘 I/O**：监控读写性能
- **磁盘空间**：保持充足空间

#### 网络指标
- **网络带宽**：监控网络流量
- **网络延迟**：目标 < 50ms
- **网络丢包率**：目标 < 0.1%

### 3. 业务指标

#### 用户活跃度
- **日活跃用户**：DAU
- **月活跃用户**：MAU
- **用户留存率**：次日、7日、30日

#### 业务处理
- **订单处理量**：每日订单数
- **数据处理量**：数据量统计
- **业务成功率**：业务操作成功率

## 监控工具

### 1. 系统监控

#### Prometheus + Grafana
- **数据收集**：Prometheus 收集指标
- **数据可视化**：Grafana 展示图表
- **告警管理**：Prometheus Alertmanager

#### 配置示例
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
  
  - job_name: 'application'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
```

### 2. 日志监控

#### ELK Stack
- **Elasticsearch**：日志存储和搜索
- **Logstash**：日志收集和处理
- **Kibana**：日志可视化和分析

#### 日志格式
```json
{
  "timestamp": "2024-01-01T00:00:00Z",
  "level": "INFO",
  "service": "user-service",
  "message": "User login successful",
  "user_id": "12345",
  "ip": "192.168.1.1",
  "duration": 150
}
```

### 3. 应用性能监控

#### APM 工具
- **New Relic**：全栈性能监控
- **Datadog**：基础设施和应用监控
- **自研监控**：基于 OpenTelemetry

## 告警机制

### 告警级别

#### P0 - 紧急告警
- **影响**：系统完全不可用
- **响应时间**：立即响应（5分钟内）
- **通知方式**：电话 + 短信 + 邮件 + 钉钉

#### P1 - 严重告警
- **影响**：核心功能不可用
- **响应时间**：快速响应（15分钟内）
- **通知方式**：短信 + 邮件 + 钉钉

#### P2 - 重要告警
- **影响**：部分功能受影响
- **响应时间**：及时响应（1小时内）
- **通知方式**：邮件 + 钉钉

#### P3 - 一般告警
- **影响**：轻微影响
- **响应时间**：正常响应（4小时内）
- **通知方式**：邮件

### 告警规则

#### 系统告警规则
```yaml
# alerting_rules.yml
groups:
  - name: system_alerts
    rules:
      - alert: HighCPUUsage
        expr: cpu_usage > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU 使用率过高"
          description: "CPU 使用率超过 80%，持续 5 分钟"
      
      - alert: HighMemoryUsage
        expr: memory_usage > 85
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率超过 85%，持续 5 分钟"
```

#### 应用告警规则
```yaml
      - alert: HighErrorRate
        expr: error_rate > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "错误率过高"
          description: "应用错误率超过 5%，持续 2 分钟"
      
      - alert: SlowResponseTime
        expr: response_time_95 > 1000
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "响应时间过慢"
          description: "95% 分位响应时间超过 1 秒，持续 3 分钟"
```

## 监控面板

### 1. 系统概览面板

#### 关键指标
- 系统状态概览
- 资源使用趋势
- 服务健康状态
- 告警统计信息

#### 实时监控
- CPU、内存、磁盘使用率
- 网络流量和延迟
- 进程状态和数量
- 系统负载情况

### 2. 应用性能面板

#### 性能指标
- 响应时间分布
- 吞吐量趋势
- 错误率统计
- 用户活跃度

#### 业务指标
- 业务处理量
- 成功率统计
- 用户行为分析
- 功能使用情况

### 3. 运维面板

#### 运维信息
- 服务部署状态
- 日志分析结果
- 告警处理进度
- 系统变更记录

## 运维流程

### 1. 日常巡检

#### 巡检内容
- 系统资源使用情况
- 应用性能指标
- 错误日志分析
- 告警处理情况

#### 巡检频率
- **实时监控**：24/7 持续监控
- **小时巡检**：每小时检查关键指标
- **日巡检**：每日全面检查
- **周巡检**：每周深度分析

### 2. 告警处理

#### 处理流程
1. **告警接收**：接收告警通知
2. **问题确认**：确认问题真实性
3. **影响评估**：评估问题影响范围
4. **问题处理**：执行解决方案
5. **结果验证**：验证问题是否解决
6. **总结复盘**：总结经验教训

#### 升级策略
- **自动升级**：P0 告警自动升级
- **人工升级**：P1/P2 告警人工判断
- **通知升级**：根据响应时间升级

### 3. 性能优化

#### 优化流程
1. **性能分析**：分析性能瓶颈
2. **优化方案**：制定优化方案
3. **方案实施**：执行优化措施
4. **效果验证**：验证优化效果
5. **持续监控**：持续监控性能

## 监控最佳实践

### 1. 指标设计

#### 黄金指标
- **延迟**：响应时间
- **吞吐量**：处理能力
- **错误率**：错误数量
- **饱和度**：资源使用率

#### 业务指标
- **用户指标**：活跃用户、留存率
- **业务指标**：订单量、成功率
- **财务指标**：收入、成本

### 2. 告警设计

#### 告警原则
- **避免告警疲劳**：合理设置阈值
- **提供上下文**：包含足够信息
- **分级处理**：不同级别不同处理
- **自动化处理**：减少人工干预

### 3. 监控维护

#### 定期维护
- **规则优化**：优化告警规则
- **阈值调整**：调整监控阈值
- **面板更新**：更新监控面板
- **工具升级**：升级监控工具

## 下一步

- [备份恢复](./backup-restore.md) - 数据备份和恢复
- [性能调优](./performance-tuning.md) - 系统性能优化
- [扩容方案](./scaling.md) - 系统扩容策略
- [灾难恢复](./disaster-recovery.md) - 容灾方案

## 相关资源

- **监控工具文档**：Prometheus、Grafana、ELK
- **最佳实践指南**：监控设计原则
- **故障案例库**：常见问题和解决方案
- **运维手册**：详细运维流程
